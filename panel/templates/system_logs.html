{% extends "base.html" %}

{% block title %}Ù„Ø§Ú¯ Ø³ÛŒØ³ØªÙ… | OCServ Panel{% endblock %}

{% block page_title %}Ù„Ø§Ú¯ Ø³ÛŒØ³ØªÙ…{% endblock %}

{% block content %}
<div class="system-logs-page">
    <!-- Log Type Tabs -->
    <div class="log-tabs">
        <button class="log-tab" data-type="live" onclick="switchLogType('live', this)">
            ğŸ“¡ Ù…Ø§Ù†ÛŒØªÙˆØ± Ø²Ù†Ø¯Ù‡
        </button>
        <button class="log-tab active" data-type="panel" onclick="switchLogType('panel', this)">
            ğŸ–¥ï¸ Ù¾Ù†Ù„
        </button>
        <button class="log-tab" data-type="ocserv" onclick="switchLogType('ocserv', this)">
            ğŸ”Œ OCServ
        </button>
        <button class="log-tab" data-type="traffic" onclick="switchLogType('traffic', this)">
            ğŸ“Š ØªØ±Ø§ÙÛŒÚ©
        </button>
        <button class="log-tab" data-type="connections" onclick="switchLogType('connections', this)">
            ğŸ”— Ø§ØªØµØ§Ù„Ø§Øª
        </button>
    </div>

    <!-- Controls -->
    <div class="log-controls">
        <div class="log-filter">
            <input type="text" id="log-search" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù„Ø§Ú¯..." oninput="filterLogs()">
        </div>
        <div class="log-actions">
            <label class="toggle-wrapper">
                <input type="checkbox" id="auto-scroll" checked>
                <span class="toggle-slider"></span>
                <span class="toggle-text">Ø§Ø³Ú©Ø±ÙˆÙ„ Ø®ÙˆØ¯Ú©Ø§Ø±</span>
            </label>
            <label class="toggle-wrapper">
                <input type="checkbox" id="live-mode" onchange="toggleLiveMode()">
                <span class="toggle-slider"></span>
                <span class="toggle-text">ğŸ”´ Ø²Ù†Ø¯Ù‡</span>
            </label>
            <button class="btn btn-secondary" onclick="clearLogs()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <polyline points="3 6 5 6 21 6" />
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                </svg>
                Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†
            </button>
            <button class="btn btn-primary" onclick="refreshLogs()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <polyline points="23 4 23 10 17 10" />
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
                </svg>
                Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
            </button>
        </div>
    </div>

    <!-- Log Stats -->
    <div class="log-stats">
        <span id="log-count">0 Ø®Ø·</span>
        <span id="log-size">-</span>
    </div>

    <!-- Log Viewer -->
    <div class="log-viewer" id="log-viewer">
        <div class="log-loading">
            <div class="loading-spinner"></div>
            <span>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentLogType = 'panel';
    let eventSource = null;
    let allLogs = [];

    document.addEventListener('DOMContentLoaded', () => {
        checkAuth();
        loadLogs('panel');
        loadLogStats();
    });

    async function loadLogs(type) {
        currentLogType = type;
        const viewer = document.getElementById('log-viewer');
        viewer.innerHTML = '<div class="log-loading"><div class="loading-spinner"></div><span>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span></div>';

        try {
            if (type === 'live') {
                // Live traffic monitor - different display
                await loadLiveTraffic();
                return;
            }

            const data = await apiGet(`/api/logs/${type}?lines=200`);
            allLogs = data.logs || [];
            renderLogs();
            document.getElementById('log-count').textContent = `${allLogs.length} Ø®Ø·`;
        } catch (error) {
            console.error('Error loading logs:', error);
            viewer.innerHTML = '<div class="log-error">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„Ø§Ú¯â€ŒÙ‡Ø§</div>';
        }
    }

    async function loadLiveTraffic() {
        const viewer = document.getElementById('log-viewer');
        try {
            const users = await apiGet('/api/dashboard/live-traffic');

            if (users.length === 0) {
                viewer.innerHTML = '<div class="log-empty">Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ† Ù†ÛŒØ³Øª</div>';
                document.getElementById('log-count').textContent = '0 Ú©Ø§Ø±Ø¨Ø±';
                return;
            }

            let html = '<div class="live-traffic-grid">';
            for (const user of users) {
                const rxSpeed = formatSpeed(user.rx_speed);
                const txSpeed = formatSpeed(user.tx_speed);
                const totalUsed = formatBytes(user.total_used);
                const maxTraffic = user.max_traffic > 0 ? formatBytes(user.max_traffic) : 'âˆ';
                const percent = user.max_traffic > 0 ? Math.round((user.total_used / user.max_traffic) * 100) : 0;

                html += `
                <div class="live-user-card">
                    <div class="live-user-header">
                        <span class="live-user-avatar">${user.username.charAt(0).toUpperCase()}</span>
                        <div class="live-user-info">
                            <strong>${user.username}</strong>
                            <span class="live-conn-count">${user.connections} Ø§ØªØµØ§Ù„</span>
                        </div>
                        <span class="live-status-dot"></span>
                    </div>
                    <div class="live-speeds">
                        <div class="speed-item download">
                            <span class="speed-arrow">â†“</span>
                            <span class="speed-value">${rxSpeed}</span>
                        </div>
                        <div class="speed-item upload">
                            <span class="speed-arrow">â†‘</span>
                            <span class="speed-value">${txSpeed}</span>
                        </div>
                    </div>
                    <div class="live-traffic-bar">
                        <div class="traffic-progress" style="width: ${Math.min(percent, 100)}%"></div>
                    </div>
                    <div class="live-traffic-text">
                        ${totalUsed} / ${maxTraffic}
                    </div>
                    <div class="live-ips">
                        ${user.client_ips.map(ip => `<span class="live-ip">ğŸ“± ${ip}</span>`).join('')}
                    </div>
                </div>`;
            }
            html += '</div>';
            viewer.innerHTML = html;
            document.getElementById('log-count').textContent = `${users.length} Ú©Ø§Ø±Ø¨Ø± Ø¢Ù†Ù„Ø§ÛŒÙ†`;
        } catch (error) {
            console.error('Error loading live traffic:', error);
            viewer.innerHTML = '<div class="log-error">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ±Ø§ÙÛŒÚ©</div>';
        }
    }

    function formatSpeed(bytesPerSec) {
        if (!bytesPerSec || bytesPerSec < 1) return '0 B/s';
        const units = ['B/s', 'KB/s', 'MB/s', 'GB/s'];
        let i = 0;
        while (bytesPerSec >= 1024 && i < units.length - 1) {
            bytesPerSec /= 1024;
            i++;
        }
        return bytesPerSec.toFixed(1) + ' ' + units[i];
    }

    function renderLogs() {
        const viewer = document.getElementById('log-viewer');
        const search = document.getElementById('log-search').value.toLowerCase();

        let filteredLogs = allLogs;
        if (search) {
            filteredLogs = allLogs.filter(log => log.toLowerCase().includes(search));
        }

        if (filteredLogs.length === 0) {
            viewer.innerHTML = '<div class="log-empty">Ù„Ø§Ú¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
            return;
        }

        viewer.innerHTML = filteredLogs.map(log => {
            let logClass = 'log-line';
            if (log.includes('ERROR') || log.includes('error')) logClass += ' log-error';
            else if (log.includes('WARNING') || log.includes('warning')) logClass += ' log-warning';
            else if (log.includes('INFO') || log.includes('info')) logClass += ' log-info';

            return `<div class="${logClass}">${escapeHtml(log)}</div>`;
        }).join('');

        // Auto scroll
        if (document.getElementById('auto-scroll').checked) {
            viewer.scrollTop = viewer.scrollHeight;
        }
    }

    let liveInterval = null;

    function toggleLiveMode() {
        const isLive = document.getElementById('live-mode').checked;
        const liveBtn = document.querySelector('.toggle-text');

        if (isLive) {
            // Start polling every 2 seconds
            liveInterval = setInterval(async () => {
                try {
                    const data = await apiGet(`/api/logs/${currentLogType}?lines=200`);
                    const newLogs = data.logs || [];

                    // Check if there are new logs
                    if (newLogs.length !== allLogs.length ||
                        (newLogs.length > 0 && newLogs[newLogs.length - 1] !== allLogs[allLogs.length - 1])) {
                        allLogs = newLogs;
                        renderLogs();
                        document.getElementById('log-count').textContent = `${allLogs.length} Ø®Ø·`;
                    }
                } catch (error) {
                    console.error('Error polling logs:', error);
                }
            }, 2000);

            showToast('Ø­Ø§Ù„Øª Ø²Ù†Ø¯Ù‡ ÙØ¹Ø§Ù„ Ø´Ø¯', 'success');
        } else {
            if (liveInterval) {
                clearInterval(liveInterval);
                liveInterval = null;
            }
            showToast('Ø­Ø§Ù„Øª Ø²Ù†Ø¯Ù‡ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯', 'info');
        }
    }

    let liveMonitorInterval = null;  // Separate interval for live monitor

    function switchLogType(type, btn) {
        // Update active tab
        document.querySelectorAll('.log-tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');

        // Stop any existing intervals
        if (liveInterval) {
            clearInterval(liveInterval);
            liveInterval = null;
            document.getElementById('live-mode').checked = false;
        }
        if (liveMonitorInterval) {
            clearInterval(liveMonitorInterval);
            liveMonitorInterval = null;
        }

        // If live monitor - auto-start refresh
        if (type === 'live') {
            loadLogs(type);
            // Auto refresh every 3 seconds
            liveMonitorInterval = setInterval(() => {
                loadLiveTraffic();
            }, 3000);
        } else {
            loadLogs(type);
        }
    }

    function filterLogs() {
        renderLogs();
    }

    function clearLogs() {
        allLogs = [];
        renderLogs();
        document.getElementById('log-count').textContent = '0 Ø®Ø·';
    }

    function refreshLogs() {
        loadLogs(currentLogType);
    }

    async function loadLogStats() {
        try {
            const stats = await apiGet('/api/logs/stats');
            let totalSize = 0;
            Object.values(stats).forEach(s => totalSize += s.size);
            document.getElementById('log-size').textContent = `Ø­Ø¬Ù… Ú©Ù„: ${formatBytes(totalSize)}`;
        } catch (error) {
            console.error('Error loading log stats:', error);
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}