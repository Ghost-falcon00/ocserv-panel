{% extends "base.html" %}

{% block title %}ØªØ§Ù†Ù„ Ø¶Ø¯ ÙÛŒÙ„ØªØ± - OCServ Panel{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ğŸ”’ ØªØ§Ù†Ù„ Ø¶Ø¯ ÙÛŒÙ„ØªØ±</h1>
    <p class="page-description">Ø§ØªØµØ§Ù„ Ø§Ù…Ù† Ùˆ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø®Ø§Ø±Ø¬ÛŒ</p>
</div>

<!-- Status Card -->
<div class="tunnel-status-card" id="tunnel-status-card">
    <div class="status-indicator">
        <div class="status-icon" id="status-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
            </svg>
        </div>
        <div class="status-info">
            <h3 id="status-title">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...</h3>
            <p id="status-description">Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯</p>
        </div>
    </div>
    <div class="status-actions">
        <button class="btn btn-success" id="start-btn" onclick="startTunnel()" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="5 3 19 12 5 21 5 3" />
            </svg>
            Ø´Ø±ÙˆØ¹
        </button>
        <button class="btn btn-danger" id="stop-btn" onclick="stopTunnel()" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="6" y="6" width="12" height="12" rx="2" />
            </svg>
            ØªÙˆÙ‚Ù
        </button>
        <button class="btn btn-secondary" id="stealth-btn" onclick="applyStealthConfig()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
            </svg>
            Ø§Ø¹Ù…Ø§Ù„ Stealth
        </button>
    </div>
</div>

<!-- Security Features Card -->
<div class="card security-card">
    <div class="card-header">
        <h2>ğŸ›¡ï¸ Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø¶Ø¯ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ</h2>
    </div>
    <div class="card-body">
        <div class="security-features">
            <div class="feature-item active">
                <div class="feature-icon">ğŸ”</div>
                <div class="feature-info">
                    <h4>TLS 1.3</h4>
                    <p>Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</p>
                </div>
            </div>
            <div class="feature-item active">
                <div class="feature-icon">ğŸŒ</div>
                <div class="feature-info">
                    <h4>HTTP/2 Mux</h4>
                    <p>Ù¾Ù†Ù‡Ø§Ù†â€ŒØ³Ø§Ø²ÛŒ Ù¾ØªØ±Ù†</p>
                </div>
            </div>
            <div class="feature-item active">
                <div class="feature-icon">ğŸ“¦</div>
                <div class="feature-info">
                    <h4>Padding</h4>
                    <p>Ø§Ù†Ø¯Ø§Ø²Ù‡ ØªØµØ§Ø¯ÙÛŒ Ù¾Ú©Øª</p>
                </div>
            </div>
            <div class="feature-item active">
                <div class="feature-icon">ğŸ­</div>
                <div class="feature-info">
                    <h4>SNI Masquerade</h4>
                    <p>Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø³Ø§ÛŒØª Ù…Ø¹ØªØ¨Ø±</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Card -->
<div class="card">
    <div class="card-header">
        <h2>âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªØ§Ù†Ù„</h2>
    </div>
    <div class="card-body">
        <form id="tunnel-config-form" onsubmit="saveTunnelConfig(event)">
            <!-- Server Settings -->
            <h3 class="section-title">ğŸ“¡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³Ø±ÙˆØ±</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="remote_ip">Ø¢ÛŒâ€ŒÙ¾ÛŒ Ø³Ø±ÙˆØ± ÙØ±Ø§Ù†Ø³Ù‡</label>
                    <input type="text" id="remote_ip" name="remote_ip" placeholder="Ù…Ø«Ø§Ù„: 45.13.119.218" required>
                    <small>Ø¢ÛŒâ€ŒÙ¾ÛŒ Ø³Ø±ÙˆØ± Ø®Ø§Ø±Ø¬ÛŒ Ú©Ù‡ OCServ Ø±ÙˆÛŒ Ø¢Ù† Ù†ØµØ¨ Ø§Ø³Øª</small>
                </div>
                <div class="form-group">
                    <label for="remote_port">Ù¾ÙˆØ±Øª OCServ</label>
                    <input type="number" id="remote_port" name="remote_port" value="2083" min="1" max="65535">
                    <small>Ù¾ÙˆØ±Øª Ø³Ø±ÙˆÛŒØ³ VPN (Ù¾ÛŒØ´â€ŒÙØ±Ø¶: 2083)</small>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="local_port">Ù¾ÙˆØ±Øª ÙˆØ±ÙˆØ¯ÛŒ (Ø§ÛŒØ±Ø§Ù†)</label>
                    <input type="number" id="local_port" name="local_port" value="443" min="1" max="65535">
                    <small>Ù¾ÙˆØ±ØªÛŒ Ú©Ù‡ Ú©Ù„Ø§ÛŒÙ†Øªâ€ŒÙ‡Ø§ Ø¨Ù‡Ø´ ÙˆØµÙ„ Ù…ÛŒØ´Ù† (443 Ø¨Ù‡ØªØ±ÛŒÙ†)</small>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="button" class="btn btn-secondary" onclick="testConnection()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                            <polyline points="22 4 12 14.01 9 11.01" />
                        </svg>
                        ØªØ³Øª Ø§ØªØµØ§Ù„
                    </button>
                </div>
            </div>

            <!-- Anti-Detection Settings -->
            <h3 class="section-title">ğŸ”’ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¶Ø¯ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="protocol">Ù¾Ø±ÙˆØªÚ©Ù„ ØªØ§Ù†Ù„</label>
                    <select id="protocol" name="protocol">
                        <option value="h2">HTTP/2 (Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ - Ø³Ø±ÛŒØ¹ Ùˆ Ù…Ø®ÙÛŒ)</option>
                        <option value="wss">WebSocket Secure (Ø´Ø¨ÛŒÙ‡ ÙˆØ¨)</option>
                        <option value="tls">TLS Ø®Ø§Ù„Øµ (Ø³Ø§Ø¯Ù‡)</option>
                    </select>
                    <small>HTTP/2 Ø¨Ù‡ØªØ±ÛŒÙ† Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø±Ø§ÛŒ Ø¹Ø¨ÙˆØ± Ø§Ø² DPI</small>
                </div>
                <div class="form-group">
                    <label for="sni">SNI (Server Name Indication)</label>
                    <select id="sni" name="sni">
                        <option value="www.google.com">www.google.com</option>
                        <option value="www.cloudflare.com">www.cloudflare.com</option>
                        <option value="www.microsoft.com">www.microsoft.com</option>
                        <option value="www.apple.com">www.apple.com</option>
                        <option value="www.amazon.com">www.amazon.com</option>
                        <option value="www.github.com">www.github.com</option>
                        <option value="update.microsoft.com">update.microsoft.com</option>
                        <option value="dl.google.com">dl.google.com</option>
                    </select>
                    <small>Ø³Ø§ÛŒØªÛŒ Ú©Ù‡ ØªØ±Ø§ÙÛŒÚ© Ø´Ù…Ø§ Ø´Ø¨ÛŒÙ‡ Ø§ÙˆÙ† Ø¨Ù‡ Ù†Ø¸Ø± Ù…ÛŒØ±Ø³Ù‡</small>
                </div>
            </div>

            <!-- Advanced Options -->
            <div class="form-row advanced-options">
                <div class="form-group checkbox-group">
                    <label class="toggle-label">
                        <input type="checkbox" id="mux" name="mux" checked>
                        <span class="toggle-switch"></span>
                        <span class="toggle-text">
                            <strong>Multiplexing</strong>
                            <small>Ú†Ù†Ø¯ Ø¬Ø±ÛŒØ§Ù† Ø¯Ø± ÛŒÚ© Ø§ØªØµØ§Ù„ (Ù¾Ù†Ù‡Ø§Ù†â€ŒØ³Ø§Ø²ÛŒ Ù¾ØªØ±Ù†)</small>
                        </span>
                    </label>
                </div>
                <div class="form-group checkbox-group">
                    <label class="toggle-label">
                        <input type="checkbox" id="padding" name="padding" checked>
                        <span class="toggle-switch"></span>
                        <span class="toggle-text">
                            <strong>Random Padding</strong>
                            <small>Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØµØ§Ø¯ÙÛŒ Ø¨Ù‡ Ù¾Ú©Øªâ€ŒÙ‡Ø§</small>
                        </span>
                    </label>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                        <polyline points="17 21 17 13 7 13 7 21" />
                        <polyline points="7 3 7 8 15 8" />
                    </svg>
                    Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Test Result Modal -->
<div class="modal" id="test-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Ù†ØªÛŒØ¬Ù‡ ØªØ³Øª Ø§ØªØµØ§Ù„</h3>
            <button class="modal-close" onclick="closeModal('test-modal')">&times;</button>
        </div>
        <div class="modal-body" id="test-result">
            <!-- Results will be inserted here -->
        </div>
    </div>
</div>

<!-- Remote Sync Config -->
<div class="card sync-card">
    <div class="card-header">
        <h2>ğŸ”„ Ø³ÛŒÙ†Ú© Ø¨Ø§ Ø³Ø±ÙˆØ± ÙØ±Ø§Ù†Ø³Ù‡</h2>
        <span class="sync-badge" id="sync-badge">ØºÛŒØ±ÙØ¹Ø§Ù„</span>
    </div>
    <div class="card-body">
        <div class="sync-status" id="sync-status">
            <div class="sync-indicator" id="sync-indicator">âš«</div>
            <span id="sync-message">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...</span>
        </div>

        <form id="sync-config-form" onsubmit="saveSyncConfig(event)">
            <div class="form-row">
                <div class="form-group">
                    <label for="sync_ip">IP Ø³Ø±ÙˆØ± ÙØ±Ø§Ù†Ø³Ù‡</label>
                    <input type="text" id="sync_ip" name="sync_ip" placeholder="185.171.202.155">
                    <small>Ù‡Ù…ÙˆÙ† IP Ø³Ø±ÙˆØ± ÙØ±Ø§Ù†Ø³Ù‡</small>
                </div>
                <div class="form-group">
                    <label for="sync_port">Ù¾ÙˆØ±Øª Remote API</label>
                    <input type="number" id="sync_port" name="sync_port" value="6443" min="1" max="65535">
                    <small>Ù¾ÛŒØ´â€ŒÙØ±Ø¶: 6443</small>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group" style="flex: 2">
                    <label for="sync_token">ØªÙˆÚ©Ù† API</label>
                    <input type="text" id="sync_token" name="sync_token" placeholder="ØªÙˆÚ©Ù†ÛŒ Ú©Ù‡ france-setup.sh Ø¨Ù‡Øª Ø¯Ø§Ø¯">
                    <small>ØªÙˆÚ©Ù† Ø§Ù…Ù†ÛŒØªÛŒ Ø§Ø² Ø®Ø±ÙˆØ¬ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù†ØµØ¨ ÙØ±Ø§Ù†Ø³Ù‡</small>
                </div>
            </div>
            <div class="form-actions" style="gap: 12px; justify-content: flex-start">
                <button type="submit" class="btn btn-primary">
                    ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ø³ÛŒÙ†Ú©
                </button>
                <button type="button" class="btn btn-secondary" onclick="testSyncConnection()">
                    ğŸ” ØªØ³Øª Ø§Ø±ØªØ¨Ø§Ø·
                </button>
            </div>
        </form>

        <div class="sync-info">
            <small>âš¡ ÙˆÙ‚ØªÛŒ Ø³ÛŒÙ†Ú© ÙØ¹Ø§Ù„ Ø¨Ø´Ù‡ØŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†ÛŒ Ú©Ù‡ ØªÙˆÛŒ Ù¾Ù†Ù„ Ù…ÛŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø±ÙˆÛŒ ÙØ±Ø§Ù†Ø³Ù‡ Ù‡Ù… Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒØ´Ù†</small>
        </div>
    </div>
</div>

<!-- Help Section -->
<div class="card help-card">
    <div class="card-header">
        <h2>ğŸ“– Ø±Ø§Ù‡Ù†Ù…Ø§</h2>
    </div>
    <div class="card-body">
        <div class="help-section">
            <h4>ğŸ”§ Ù†Ø­ÙˆÙ‡ ØªÙ†Ø¸ÛŒÙ…:</h4>
            <ol>
                <li>IP Ø³Ø±ÙˆØ± ÙØ±Ø§Ù†Ø³Ù‡ Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù†</li>
                <li>Ø¯Ú©Ù…Ù‡ "ØªØ³Øª Ø§ØªØµØ§Ù„" Ø±Ùˆ Ø¨Ø²Ù†</li>
                <li>Ù¾Ø±ÙˆØªÚ©Ù„ <strong>HTTP/2</strong> Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† (Ø³Ø±ÛŒØ¹â€ŒØªØ± Ùˆ Ø§Ù…Ù†â€ŒØªØ±)</li>
                <li>ÛŒÙ‡ SNI Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† (ØªØ±Ø§ÙÛŒÚ©Øª Ø´Ø¨ÛŒÙ‡ Ø§ÙˆÙ† Ø³Ø§ÛŒØª Ù…ÛŒØ´Ù‡)</li>
                <li><strong>Multiplexing</strong> Ùˆ <strong>Padding</strong> Ø±Ùˆ ÙØ¹Ø§Ù„ Ø¨Ø°Ø§Ø±</li>
                <li>Ø°Ø®ÛŒØ±Ù‡ Ú©Ù† Ùˆ "Ø´Ø±ÙˆØ¹" Ø±Ùˆ Ø¨Ø²Ù†</li>
                <li><strong>Ø³ÛŒÙ†Ú©</strong> Ø±Ùˆ ØªÙ†Ø¸ÛŒÙ… Ú©Ù† ØªØ§ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ù‡ ÙØ±Ø§Ù†Ø³Ù‡ Ù…Ù†ØªÙ‚Ù„ Ø¨Ø´Ù†</li>
            </ol>
        </div>
        <div class="help-section success">
            <h4>âœ… Ú†Ø±Ø§ Ø§ÛŒÙ† ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ù…Ù†â€ŒØªØ±Ù†ØŸ</h4>
            <ul>
                <li><strong>HTTP/2:</strong> ØªØ±Ø§ÙÛŒÚ©Øª Ù…Ø«Ù„ ÛŒÙ‡ Ø³Ø§ÛŒØª Ø¹Ø§Ø¯ÛŒ Ø¨Ù‡ Ù†Ø¸Ø± Ù…ÛŒØ±Ø³Ù‡</li>
                <li><strong>SNI Masquerade:</strong> ÙÛŒÙ„ØªØ±Ú†ÛŒ ÙÚ©Ø± Ù…ÛŒÚ©Ù†Ù‡ Ø¯Ø§Ø±ÛŒ Ú¯ÙˆÚ¯Ù„ Ø±Ùˆ Ø¨Ø§Ø² Ù…ÛŒÚ©Ù†ÛŒ</li>
                <li><strong>Multiplexing:</strong> Ù¾ØªØ±Ù† ØªØ±Ø§ÙÛŒÚ© VPN Ø±Ùˆ Ù…Ø®ÙÛŒ Ù…ÛŒÚ©Ù†Ù‡</li>
                <li><strong>Padding:</strong> Ø³Ø§ÛŒØ² Ù¾Ú©Øªâ€ŒÙ‡Ø§ ØªØµØ§Ø¯ÙÛŒ Ù…ÛŒØ´Ù‡</li>
                <li><strong>Ø³ÛŒÙ†Ú© Ø®ÙˆØ¯Ú©Ø§Ø±:</strong> Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨ÛŒÙ† Ø§ÛŒØ±Ø§Ù† Ùˆ ÙØ±Ø§Ù†Ø³Ù‡ Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ù…ÛŒØ´Ù†</li>
            </ul>
        </div>
        <div class="help-section warning">
            <h4>âš ï¸ Ù†Ú©ØªÙ‡ Ù…Ù‡Ù…:</h4>
            <p>Ø¨Ø¹Ø¯ Ø§Ø² ØªÙ†Ø¸ÛŒÙ…ØŒ Ú©Ù„Ø§ÛŒÙ†Øªâ€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ <strong>IP Ø³Ø±ÙˆØ± Ø§ÛŒØ±Ø§Ù†:443</strong> ÙˆØµÙ„ Ø´Ù†.</p>
        </div>
    </div>
</div>

<style>
    .tunnel-status-card {
        background: linear-gradient(135deg, var(--card-bg) 0%, rgba(99, 102, 241, 0.1) 100%);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--border-color);
    }

    .status-indicator {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .status-icon {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-secondary);
    }

    .status-icon svg {
        width: 32px;
        height: 32px;
    }

    .status-icon.running {
        background: rgba(34, 197, 94, 0.2);
        animation: pulse 2s infinite;
    }

    .status-icon.running svg {
        stroke: #22c55e;
    }

    .status-icon.stopped {
        background: rgba(239, 68, 68, 0.2);
    }

    .status-icon.stopped svg {
        stroke: #ef4444;
    }

    .status-icon.loading svg {
        animation: spin 1s linear infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            transform: scale(1);
            opacity: 1;
        }

        50% {
            transform: scale(1.05);
            opacity: 0.8;
        }
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    .status-info h3 {
        margin: 0 0 4px 0;
        font-size: 1.5rem;
    }

    .status-info p {
        margin: 0;
        color: var(--text-secondary);
    }

    .status-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    /* Security Features */
    .security-card {
        margin-bottom: 24px;
    }

    .security-features {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    .feature-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
    }

    .feature-item.active {
        border-color: #22c55e;
        background: rgba(34, 197, 94, 0.1);
    }

    .feature-icon {
        font-size: 24px;
    }

    .feature-info h4 {
        margin: 0;
        font-size: 0.95rem;
    }

    .feature-info p {
        margin: 4px 0 0 0;
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    /* Form Styles */
    .section-title {
        margin: 24px 0 16px 0;
        font-size: 1.1rem;
        color: var(--primary);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 8px;
    }

    .section-title:first-of-type {
        margin-top: 0;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group small {
        display: block;
        color: var(--text-secondary);
        font-size: 0.85rem;
        margin-top: 4px;
    }

    .form-actions {
        margin-top: 24px;
        display: flex;
        justify-content: flex-end;
    }

    /* Toggle Switch */
    .advanced-options {
        margin-top: 16px;
    }

    .checkbox-group {
        margin-bottom: 0;
    }

    .toggle-label {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }

    .toggle-label input {
        display: none;
    }

    .toggle-switch {
        width: 48px;
        height: 24px;
        background: var(--bg-tertiary);
        border-radius: 12px;
        position: relative;
        transition: all 0.3s ease;
    }

    .toggle-switch::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: all 0.3s ease;
    }

    .toggle-label input:checked+.toggle-switch {
        background: #22c55e;
    }

    .toggle-label input:checked+.toggle-switch::after {
        left: 26px;
    }

    .toggle-text {
        display: flex;
        flex-direction: column;
    }

    .toggle-text strong {
        font-size: 0.95rem;
    }

    .toggle-text small {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: 2px;
    }

    /* Help sections */
    .help-card {
        margin-top: 24px;
    }

    .help-section {
        margin-bottom: 20px;
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 8px;
    }

    .help-section:last-child {
        margin-bottom: 0;
    }

    .help-section h4 {
        margin: 0 0 12px 0;
        color: var(--text-primary);
    }

    .help-section ol,
    .help-section ul {
        margin: 0;
        padding-right: 20px;
    }

    .help-section li {
        margin-bottom: 8px;
    }

    .help-section.success {
        background: rgba(34, 197, 94, 0.1);
        border-right: 4px solid #22c55e;
    }

    .help-section.warning {
        background: rgba(234, 179, 8, 0.1);
        border-right: 4px solid #eab308;
    }

    /* Test result styles */
    .test-result-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid var(--border-color);
    }

    .test-result-item:last-child {
        border-bottom: none;
    }

    .test-success {
        color: #22c55e;
    }

    .test-error {
        color: #ef4444;
    }

    .loading-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        padding: 24px;
    }

    /* Sync Card */
    .sync-card {
        margin-top: 24px;
    }

    .sync-card .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .sync-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }

    .sync-badge.connected {
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
    }

    .sync-status {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        background: var(--bg-secondary);
        border-radius: 8px;
        margin-bottom: 16px;
        font-size: 0.9rem;
    }

    .sync-info {
        margin-top: 16px;
        padding: 10px 14px;
        background: rgba(99, 102, 241, 0.1);
        border-radius: 8px;
        border-right: 3px solid var(--primary);
        color: var(--text-secondary);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .tunnel-status-card {
            flex-direction: column;
            gap: 20px;
        }

        .status-actions {
            width: 100%;
            justify-content: center;
        }

        .security-features {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    let currentConfig = {};

    document.addEventListener('DOMContentLoaded', () => {
        loadTunnelStatus();
        loadTunnelConfig();
        loadSyncStatus();
    });

    async function loadTunnelStatus() {
        try {
            const response = await fetch('/api/tunnel/status', {
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });
            const data = await response.json();
            updateStatusUI(data);
        } catch (error) {
            console.error('Error loading tunnel status:', error);
        }
    }

    async function loadTunnelConfig() {
        try {
            const response = await fetch('/api/tunnel/config', {
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });
            if (response.ok) {
                currentConfig = await response.json();
                document.getElementById('remote_ip').value = currentConfig.remote_ip || '';
                document.getElementById('remote_port').value = currentConfig.remote_port || 2083;
                document.getElementById('local_port').value = currentConfig.local_port || 443;
                document.getElementById('protocol').value = currentConfig.protocol || 'h2';
                document.getElementById('sni').value = currentConfig.sni || 'www.google.com';
                document.getElementById('mux').checked = currentConfig.mux !== false;
                document.getElementById('padding').checked = currentConfig.padding !== false;
            }
        } catch (error) {
            console.error('Error loading tunnel config:', error);
        }
    }

    function updateStatusUI(status) {
        const icon = document.getElementById('status-icon');
        const title = document.getElementById('status-title');
        const desc = document.getElementById('status-description');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');

        if (status.running) {
            icon.className = 'status-icon running';
            title.textContent = 'ğŸ”’ ØªØ§Ù†Ù„ Ø§Ù…Ù† ÙØ¹Ø§Ù„ Ø§Ø³Øª';
            desc.textContent = `Ù…ØªØµÙ„ Ø¨Ù‡ ${currentConfig.remote_ip || 'Ø³Ø±ÙˆØ± ÙØ±Ø§Ù†Ø³Ù‡'} Ø¨Ø§ ${currentConfig.protocol?.toUpperCase() || 'H2'}`;
            startBtn.disabled = true;
            stopBtn.disabled = false;
        } else if (status.installed) {
            icon.className = 'status-icon stopped';
            title.textContent = 'ØªØ§Ù†Ù„ ØºÛŒØ±ÙØ¹Ø§Ù„';
            desc.textContent = 'Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ø¯Ú©Ù…Ù‡ "Ø´Ø±ÙˆØ¹" Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯';
            startBtn.disabled = false;
            stopBtn.disabled = true;
        } else {
            icon.className = 'status-icon stopped';
            title.textContent = 'Gost Ù†ØµØ¨ Ù†Ø´Ø¯Ù‡';
            desc.textContent = 'ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯ØŒ Gost Ø®ÙˆØ¯Ú©Ø§Ø± Ù†ØµØ¨ Ù…ÛŒâ€ŒØ´ÙˆØ¯';
            startBtn.disabled = false;
            stopBtn.disabled = true;
        }
    }

    async function saveTunnelConfig(event) {
        event.preventDefault();

        const config = {
            remote_ip: document.getElementById('remote_ip').value,
            remote_port: parseInt(document.getElementById('remote_port').value),
            local_port: parseInt(document.getElementById('local_port').value),
            protocol: document.getElementById('protocol').value,
            sni: document.getElementById('sni').value,
            obfuscation: "tls",
            mux: document.getElementById('mux').checked,
            padding: document.getElementById('padding').checked
        };

        try {
            const response = await fetch('/api/tunnel/config', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getToken()}`
                },
                body: JSON.stringify(config)
            });

            const data = await response.json();

            if (response.ok) {
                showNotification('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¶Ø¯ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
                currentConfig = config;
                loadTunnelStatus();
            } else {
                showNotification(data.detail || 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª', 'error');
            }
        } catch (error) {
            showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
        }
    }

    async function startTunnel() {
        const startBtn = document.getElementById('start-btn');
        startBtn.disabled = true;
        startBtn.innerHTML = '<span class="loading"></span> Ø¯Ø± Ø­Ø§Ù„ Ø´Ø±ÙˆØ¹...';

        try {
            const response = await fetch('/api/tunnel/start', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });

            const data = await response.json();

            if (response.ok) {
                showNotification('ØªØ§Ù†Ù„ Ø§Ù…Ù† Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø¶Ø¯ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø±ÙˆØ¹ Ø´Ø¯ ğŸ”’', 'success');
            } else {
                showNotification(data.detail || 'Ø®Ø·Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹ ØªØ§Ù†Ù„', 'error');
            }
        } catch (error) {
            showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
        }

        loadTunnelStatus();
    }

    async function stopTunnel() {
        const stopBtn = document.getElementById('stop-btn');
        stopBtn.disabled = true;
        stopBtn.innerHTML = '<span class="loading"></span> Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ‚Ù...';

        try {
            const response = await fetch('/api/tunnel/stop', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });

            const data = await response.json();

            if (response.ok) {
                showNotification('ØªØ§Ù†Ù„ Ù…ØªÙˆÙ‚Ù Ø´Ø¯', 'success');
            } else {
                showNotification(data.detail || 'Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ‚Ù ØªØ§Ù†Ù„', 'error');
            }
        } catch (error) {
            showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
        }

        loadTunnelStatus();
    }

    async function applyStealthConfig() {
        const btn = document.getElementById('stealth-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¹Ù…Ø§Ù„...';

        try {
            const response = await fetch('/api/tunnel/apply-stealth', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });

            const data = await response.json();

            if (response.ok) {
                showNotification('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¶Ø¯ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø¨Ù‡ OCServ Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯ ğŸ›¡ï¸', 'success');
            } else {
                showNotification(data.detail || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¹Ù…Ø§Ù„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª', 'error');
            }
        } catch (error) {
            showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
        }

        btn.disabled = false;
        btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
    </svg> Ø§Ø¹Ù…Ø§Ù„ Stealth`;
    }

    async function testConnection() {
        const remoteIp = document.getElementById('remote_ip').value;
        const remotePort = document.getElementById('remote_port').value;

        if (!remoteIp) {
            showNotification('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ IP Ø³Ø±ÙˆØ± ÙØ±Ø§Ù†Ø³Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
            return;
        }

        document.getElementById('test-result').innerHTML = '<div class="loading-container"><span class="loading"></span> Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª...</div>';
        document.getElementById('test-modal').classList.add('active');

        try {
            const response = await fetch(`/api/tunnel/test?remote_ip=${remoteIp}&remote_port=${remotePort}`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });

            const data = await response.json();

            let resultHtml = `
            <div class="test-result-item">
                <span>Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø³Ø±ÙˆØ±:</span>
                <span class="${data.reachable ? 'test-success' : 'test-error'}">
                    ${data.reachable ? 'âœ“ Ø¯Ø± Ø¯Ø³ØªØ±Ø³' : 'âœ— ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¯Ø³ØªØ±Ø³'}
                </span>
            </div>
        `;

            if (data.http_code) {
                resultHtml += `
                <div class="test-result-item">
                    <span>Ú©Ø¯ HTTP:</span>
                    <span>${data.http_code}</span>
                </div>
            `;
            }

            if (data.latency_ms) {
                let latencyClass = data.latency_ms < 100 ? 'test-success' : (data.latency_ms < 200 ? '' : 'test-error');
                resultHtml += `
                <div class="test-result-item">
                    <span>ØªØ£Ø®ÛŒØ± (Ping):</span>
                    <span class="${latencyClass}">${data.latency_ms.toFixed(1)} ms</span>
                </div>
            `;
            }

            if (data.error) {
                resultHtml += `
                <div class="test-result-item">
                    <span>Ø®Ø·Ø§:</span>
                    <span class="test-error">${data.error}</span>
                </div>
            `;
            }

            document.getElementById('test-result').innerHTML = resultHtml;

        } catch (error) {
            document.getElementById('test-result').innerHTML = `
            <div class="test-error">Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª: ${error.message}</div>
        `;
        }
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    function getToken() {
        return localStorage.getItem('token') || '';
    }

    function showNotification(message, type = 'info') {
        if (typeof window.showToast === 'function') {
            window.showToast(message, type);
        } else {
            alert(message);
        }
    }

    // ========== Sync Functions ==========

    async function loadSyncStatus() {
        try {
            const response = await fetch('/api/tunnel/sync/status', {
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });
            if (response.ok) {
                const data = await response.json();
                const badge = document.getElementById('sync-badge');
                const indicator = document.getElementById('sync-indicator');
                const message = document.getElementById('sync-message');

                if (data.connected) {
                    badge.textContent = 'Ù…ØªØµÙ„ âœ“';
                    badge.className = 'sync-badge connected';
                    indicator.textContent = 'ğŸŸ¢';
                } else if (data.enabled) {
                    badge.textContent = 'Ù‚Ø·Ø¹';
                    badge.className = 'sync-badge';
                    indicator.textContent = 'ğŸ”´';
                } else {
                    badge.textContent = 'ØºÛŒØ±ÙØ¹Ø§Ù„';
                    badge.className = 'sync-badge';
                    indicator.textContent = 'âš«';
                }
                message.textContent = data.message || '';

                // Fill form
                if (data.remote_ip) {
                    document.getElementById('sync_ip').value = data.remote_ip;
                    document.getElementById('sync_port').value = data.remote_api_port || 6443;
                }
            }
        } catch (error) {
            console.error('Error loading sync status:', error);
        }
    }

    async function saveSyncConfig(event) {
        event.preventDefault();

        const config = {
            enabled: true,
            remote_ip: document.getElementById('sync_ip').value,
            remote_api_port: parseInt(document.getElementById('sync_port').value),
            api_token: document.getElementById('sync_token').value
        };

        if (!config.remote_ip || !config.api_token) {
            showNotification('IP Ùˆ ØªÙˆÚ©Ù† Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù†', 'error');
            return;
        }

        try {
            const response = await fetch('/api/tunnel/sync/config', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getToken()}`
                },
                body: JSON.stringify(config)
            });

            const data = await response.json();
            showNotification(data.message, data.success ? 'success' : 'warning');
            loadSyncStatus();
        } catch (error) {
            showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
        }
    }

    async function testSyncConnection() {
        try {
            showNotification('Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª Ø§Ø±ØªØ¨Ø§Ø·...', 'info');
            const response = await fetch('/api/tunnel/sync/test', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });

            const data = await response.json();
            showNotification(data.message, data.success ? 'success' : 'error');
            loadSyncStatus();
        } catch (error) {
            showNotification('Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª Ø§Ø±ØªØ¨Ø§Ø·', 'error');
        }
    }
</script>
{% endblock %}