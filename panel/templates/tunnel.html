{% extends "base.html" %}

{% block title %}ØªØ§Ù†Ù„ - OCServ Panel{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Ù…Ø¯ÛŒØ±ÛŒØª ØªØ§Ù†Ù„</h1>
    <p class="page-description">Ø§ØªØµØ§Ù„ Ø§Ù…Ù† Ùˆ Ø¶Ø¯ ÙÛŒÙ„ØªØ± Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø®Ø§Ø±Ø¬ÛŒ</p>
</div>

<!-- Status Card -->
<div class="tunnel-status-card" id="tunnel-status-card">
    <div class="status-indicator">
        <div class="status-icon" id="status-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
            </svg>
        </div>
        <div class="status-info">
            <h3 id="status-title">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...</h3>
            <p id="status-description">Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯</p>
        </div>
    </div>
    <div class="status-actions">
        <button class="btn btn-success" id="start-btn" onclick="startTunnel()" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="5 3 19 12 5 21 5 3" />
            </svg>
            Ø´Ø±ÙˆØ¹
        </button>
        <button class="btn btn-danger" id="stop-btn" onclick="stopTunnel()" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="6" y="6" width="12" height="12" rx="2" />
            </svg>
            ØªÙˆÙ‚Ù
        </button>
    </div>
</div>

<!-- Configuration Card -->
<div class="card">
    <div class="card-header">
        <h2>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³Ø±ÙˆØ± ÙØ±Ø§Ù†Ø³Ù‡</h2>
    </div>
    <div class="card-body">
        <form id="tunnel-config-form" onsubmit="saveTunnelConfig(event)">
            <div class="form-row">
                <div class="form-group">
                    <label for="remote_ip">Ø¢ÛŒâ€ŒÙ¾ÛŒ Ø³Ø±ÙˆØ± ÙØ±Ø§Ù†Ø³Ù‡</label>
                    <input type="text" id="remote_ip" name="remote_ip" placeholder="Ù…Ø«Ø§Ù„: 45.13.119.218" required>
                    <small>Ø¢ÛŒâ€ŒÙ¾ÛŒ Ø³Ø±ÙˆØ± Ø®Ø§Ø±Ø¬ÛŒ Ú©Ù‡ OCServ Ø±ÙˆÛŒ Ø¢Ù† Ù†ØµØ¨ Ø§Ø³Øª</small>
                </div>
                <div class="form-group">
                    <label for="remote_port">Ù¾ÙˆØ±Øª OCServ</label>
                    <input type="number" id="remote_port" name="remote_port" value="2083" min="1" max="65535">
                    <small>Ù¾ÙˆØ±Øª Ø³Ø±ÙˆÛŒØ³ VPN (Ù¾ÛŒØ´â€ŒÙØ±Ø¶: 2083)</small>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="local_port">Ù¾ÙˆØ±Øª ÙˆØ±ÙˆØ¯ÛŒ (Ø§ÛŒØ±Ø§Ù†)</label>
                    <input type="number" id="local_port" name="local_port" value="443" min="1" max="65535">
                    <small>Ù¾ÙˆØ±ØªÛŒ Ú©Ù‡ Ú©Ù„Ø§ÛŒÙ†Øªâ€ŒÙ‡Ø§ Ø¨Ù‡Ø´ ÙˆØµÙ„ Ù…ÛŒØ´Ù† (443 Ø¨Ù‡ØªØ±ÛŒÙ† Ø§Ù†ØªØ®Ø§Ø¨Ù‡)</small>
                </div>
                <div class="form-group">
                    <label for="protocol">Ù¾Ø±ÙˆØªÚ©Ù„ ØªØ§Ù†Ù„</label>
                    <select id="protocol" name="protocol">
                        <option value="relay+tls">TLS (Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ - Ø³Ø±ÛŒØ¹ Ùˆ Ø§Ù…Ù†)</option>
                        <option value="relay+wss">WebSocket Secure</option>
                        <option value="relay">Ø¨Ø¯ÙˆÙ† Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ Ø§Ø¶Ø§ÙÙ‡</option>
                    </select>
                    <small>TLS Ø¨Ù‡ØªØ±ÛŒÙ† Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø±Ø§ÛŒ Ø¹Ø¨ÙˆØ± Ø§Ø² ÙÛŒÙ„ØªØ±ÛŒÙ†Ú¯</small>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="sni">SNI (Server Name Indication)</label>
                    <input type="text" id="sni" name="sni" value="www.google.com" placeholder="www.google.com">
                    <small>Ø³Ø§ÛŒØªÛŒ Ú©Ù‡ ØªØ±Ø§ÙÛŒÚ© Ø´Ù…Ø§ Ø´Ø¨ÛŒÙ‡ Ø§ÙˆÙ† Ø¨Ù‡ Ù†Ø¸Ø± Ù…ÛŒØ±Ø³Ù‡</small>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="button" class="btn btn-secondary" onclick="testConnection()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                            <polyline points="22 4 12 14.01 9 11.01" />
                        </svg>
                        ØªØ³Øª Ø§ØªØµØ§Ù„
                    </button>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                        <polyline points="17 21 17 13 7 13 7 21" />
                        <polyline points="7 3 7 8 15 8" />
                    </svg>
                    Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Test Result Modal -->
<div class="modal" id="test-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Ù†ØªÛŒØ¬Ù‡ ØªØ³Øª Ø§ØªØµØ§Ù„</h3>
            <button class="modal-close" onclick="closeModal('test-modal')">&times;</button>
        </div>
        <div class="modal-body" id="test-result">
            <!-- Results will be inserted here -->
        </div>
    </div>
</div>

<!-- Help Section -->
<div class="card help-card">
    <div class="card-header">
        <h2>Ø±Ø§Ù‡Ù†Ù…Ø§</h2>
    </div>
    <div class="card-body">
        <div class="help-section">
            <h4>ğŸ”§ Ù†Ø­ÙˆÙ‡ ØªÙ†Ø¸ÛŒÙ…:</h4>
            <ol>
                <li>IP Ø³Ø±ÙˆØ± ÙØ±Ø§Ù†Ø³Ù‡ Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù† (Ø³Ø±ÙˆØ±ÛŒ Ú©Ù‡ OCServ Ø±ÙˆØ´ Ù†ØµØ¨Ù‡)</li>
                <li>Ù¾ÙˆØ±Øª OCServ Ø±Ùˆ Ø¨Ø²Ù† (Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ 2083 ÛŒØ§ 443)</li>
                <li>Ø¯Ú©Ù…Ù‡ "ØªØ³Øª Ø§ØªØµØ§Ù„" Ø±Ùˆ Ø¨Ø²Ù† ØªØ§ Ù…Ø·Ù…Ø¦Ù† Ø´ÛŒ Ø³Ø±ÙˆØ± Ø¯Ø± Ø¯Ø³ØªØ±Ø³Ù‡</li>
                <li>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù† Ùˆ "Ø´Ø±ÙˆØ¹" Ø±Ùˆ Ø¨Ø²Ù†</li>
            </ol>
        </div>
        <div class="help-section">
            <h4>ğŸ“± Ø§ØªØµØ§Ù„ Ú©Ù„Ø§ÛŒÙ†Øªâ€ŒÙ‡Ø§:</h4>
            <p>Ø¨Ø¹Ø¯ Ø§Ø² ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ØªØ§Ù†Ù„ØŒ Ú©Ù„Ø§ÛŒÙ†Øªâ€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ <strong>IP Ø³Ø±ÙˆØ± Ø§ÛŒØ±Ø§Ù†:443</strong> ÙˆØµÙ„ Ø´Ù† (Ù†Ù‡ ÙØ±Ø§Ù†Ø³Ù‡!)</p>
        </div>
        <div class="help-section warning">
            <h4>âš ï¸ Ù†Ú©ØªÙ‡ Ù…Ù‡Ù…:</h4>
            <p>Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø± Ú©Ø±Ø¯Ù† ØªØ§Ù†Ù„ØŒ Ø¨Ø§ÛŒØ¯ Ø±ÙˆÛŒ Ø³Ø±ÙˆØ± ÙØ±Ø§Ù†Ø³Ù‡ Ù‡Ù… Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù…Ø®ØµÙˆØµ Ø±Ùˆ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒ.</p>
        </div>
    </div>
</div>

<style>
    .tunnel-status-card {
        background: linear-gradient(135deg, var(--card-bg) 0%, rgba(99, 102, 241, 0.1) 100%);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--border-color);
    }

    .status-indicator {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .status-icon {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-secondary);
    }

    .status-icon svg {
        width: 32px;
        height: 32px;
    }

    .status-icon.running {
        background: rgba(34, 197, 94, 0.2);
        animation: pulse 2s infinite;
    }

    .status-icon.running svg {
        stroke: #22c55e;
    }

    .status-icon.stopped {
        background: rgba(239, 68, 68, 0.2);
    }

    .status-icon.stopped svg {
        stroke: #ef4444;
    }

    .status-icon.loading {
        background: rgba(234, 179, 8, 0.2);
    }

    .status-icon.loading svg {
        stroke: #eab308;
        animation: spin 1s linear infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            transform: scale(1);
            opacity: 1;
        }

        50% {
            transform: scale(1.05);
            opacity: 0.8;
        }
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    .status-info h3 {
        margin: 0 0 4px 0;
        font-size: 1.5rem;
    }

    .status-info p {
        margin: 0;
        color: var(--text-secondary);
    }

    .status-actions {
        display: flex;
        gap: 12px;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group small {
        display: block;
        color: var(--text-secondary);
        font-size: 0.85rem;
        margin-top: 4px;
    }

    .form-actions {
        margin-top: 24px;
        display: flex;
        justify-content: flex-end;
    }

    .help-card {
        margin-top: 24px;
    }

    .help-section {
        margin-bottom: 20px;
    }

    .help-section:last-child {
        margin-bottom: 0;
    }

    .help-section h4 {
        margin: 0 0 8px 0;
        color: var(--text-primary);
    }

    .help-section ol {
        margin: 0;
        padding-right: 20px;
    }

    .help-section li {
        margin-bottom: 8px;
    }

    .help-section.warning {
        background: rgba(234, 179, 8, 0.1);
        padding: 16px;
        border-radius: 8px;
        border-right: 4px solid #eab308;
    }

    /* Test result styles */
    .test-result-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid var(--border-color);
    }

    .test-result-item:last-child {
        border-bottom: none;
    }

    .test-success {
        color: #22c55e;
    }

    .test-error {
        color: #ef4444;
    }
</style>

<script>
    let currentConfig = {};

    document.addEventListener('DOMContentLoaded', () => {
        loadTunnelStatus();
        loadTunnelConfig();
    });

    async function loadTunnelStatus() {
        try {
            const response = await fetch('/api/tunnel/status', {
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });
            const data = await response.json();
            updateStatusUI(data);
        } catch (error) {
            console.error('Error loading tunnel status:', error);
        }
    }

    async function loadTunnelConfig() {
        try {
            const response = await fetch('/api/tunnel/config', {
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });
            if (response.ok) {
                currentConfig = await response.json();
                document.getElementById('remote_ip').value = currentConfig.remote_ip || '';
                document.getElementById('remote_port').value = currentConfig.remote_port || 2083;
                document.getElementById('local_port').value = currentConfig.local_port || 443;
                document.getElementById('protocol').value = currentConfig.protocol || 'relay+tls';
                document.getElementById('sni').value = currentConfig.sni || 'www.google.com';
            }
        } catch (error) {
            console.error('Error loading tunnel config:', error);
        }
    }

    function updateStatusUI(status) {
        const icon = document.getElementById('status-icon');
        const title = document.getElementById('status-title');
        const desc = document.getElementById('status-description');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');

        if (status.running) {
            icon.className = 'status-icon running';
            title.textContent = 'ØªØ§Ù†Ù„ ÙØ¹Ø§Ù„ Ø§Ø³Øª';
            desc.textContent = `Ù…ØªØµÙ„ Ø¨Ù‡ ${currentConfig.remote_ip || 'Ø³Ø±ÙˆØ± ÙØ±Ø§Ù†Ø³Ù‡'}`;
            startBtn.disabled = true;
            stopBtn.disabled = false;
        } else if (status.installed) {
            icon.className = 'status-icon stopped';
            title.textContent = 'ØªØ§Ù†Ù„ ØºÛŒØ±ÙØ¹Ø§Ù„';
            desc.textContent = 'Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ø¯Ú©Ù…Ù‡ "Ø´Ø±ÙˆØ¹" Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯';
            startBtn.disabled = false;
            stopBtn.disabled = true;
        } else {
            icon.className = 'status-icon stopped';
            title.textContent = 'Gost Ù†ØµØ¨ Ù†Ø´Ø¯Ù‡';
            desc.textContent = 'ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯ØŒ Gost Ø®ÙˆØ¯Ú©Ø§Ø± Ù†ØµØ¨ Ù…ÛŒâ€ŒØ´ÙˆØ¯';
            startBtn.disabled = false;
            stopBtn.disabled = true;
        }
    }

    async function saveTunnelConfig(event) {
        event.preventDefault();

        const config = {
            remote_ip: document.getElementById('remote_ip').value,
            remote_port: parseInt(document.getElementById('remote_port').value),
            local_port: parseInt(document.getElementById('local_port').value),
            protocol: document.getElementById('protocol').value,
            sni: document.getElementById('sni').value
        };

        try {
            const response = await fetch('/api/tunnel/config', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getToken()}`
                },
                body: JSON.stringify(config)
            });

            const data = await response.json();

            if (response.ok) {
                showNotification('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
                currentConfig = config;
                loadTunnelStatus();
            } else {
                showNotification(data.detail || 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª', 'error');
            }
        } catch (error) {
            showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
        }
    }

    async function startTunnel() {
        const startBtn = document.getElementById('start-btn');
        startBtn.disabled = true;
        startBtn.innerHTML = '<span class="loading"></span> Ø¯Ø± Ø­Ø§Ù„ Ø´Ø±ÙˆØ¹...';

        try {
            const response = await fetch('/api/tunnel/start', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });

            const data = await response.json();

            if (response.ok) {
                showNotification('ØªØ§Ù†Ù„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø´Ø±ÙˆØ¹ Ø´Ø¯', 'success');
            } else {
                showNotification(data.detail || 'Ø®Ø·Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹ ØªØ§Ù†Ù„', 'error');
            }
        } catch (error) {
            showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
        }

        loadTunnelStatus();
    }

    async function stopTunnel() {
        const stopBtn = document.getElementById('stop-btn');
        stopBtn.disabled = true;
        stopBtn.innerHTML = '<span class="loading"></span> Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ‚Ù...';

        try {
            const response = await fetch('/api/tunnel/stop', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });

            const data = await response.json();

            if (response.ok) {
                showNotification('ØªØ§Ù†Ù„ Ù…ØªÙˆÙ‚Ù Ø´Ø¯', 'success');
            } else {
                showNotification(data.detail || 'Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ‚Ù ØªØ§Ù†Ù„', 'error');
            }
        } catch (error) {
            showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
        }

        loadTunnelStatus();
    }

    async function testConnection() {
        const remoteIp = document.getElementById('remote_ip').value;
        const remotePort = document.getElementById('remote_port').value;

        if (!remoteIp) {
            showNotification('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ IP Ø³Ø±ÙˆØ± ÙØ±Ø§Ù†Ø³Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
            return;
        }

        document.getElementById('test-result').innerHTML = '<div class="loading-container"><span class="loading"></span> Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª...</div>';
        document.getElementById('test-modal').classList.add('active');

        try {
            const response = await fetch(`/api/tunnel/test?remote_ip=${remoteIp}&remote_port=${remotePort}`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });

            const data = await response.json();

            let resultHtml = `
            <div class="test-result-item">
                <span>Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø³Ø±ÙˆØ±:</span>
                <span class="${data.reachable ? 'test-success' : 'test-error'}">
                    ${data.reachable ? 'âœ“ Ø¯Ø± Ø¯Ø³ØªØ±Ø³' : 'âœ— ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¯Ø³ØªØ±Ø³'}
                </span>
            </div>
        `;

            if (data.http_code) {
                resultHtml += `
                <div class="test-result-item">
                    <span>Ú©Ø¯ HTTP:</span>
                    <span>${data.http_code}</span>
                </div>
            `;
            }

            if (data.latency_ms) {
                resultHtml += `
                <div class="test-result-item">
                    <span>ØªØ£Ø®ÛŒØ± (Ping):</span>
                    <span>${data.latency_ms.toFixed(1)} ms</span>
                </div>
            `;
            }

            if (data.error) {
                resultHtml += `
                <div class="test-result-item">
                    <span>Ø®Ø·Ø§:</span>
                    <span class="test-error">${data.error}</span>
                </div>
            `;
            }

            document.getElementById('test-result').innerHTML = resultHtml;

        } catch (error) {
            document.getElementById('test-result').innerHTML = `
            <div class="test-error">Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª: ${error.message}</div>
        `;
        }
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    function getToken() {
        return localStorage.getItem('token') || '';
    }

    function showNotification(message, type = 'info') {
        // Use existing notification system from base template
        if (typeof window.showToast === 'function') {
            window.showToast(message, type);
        } else {
            alert(message);
        }
    }
</script>
{% endblock %}